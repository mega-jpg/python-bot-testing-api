<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User CRUD Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 32px; }
        input, button { margin: 4px; }
        .user-list { margin-top: 24px; }
        .user-item { border-bottom: 1px solid #ccc; padding: 8px 0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h2>CRUD User Demo (FastAPI + MongoDB)</h2>
    <div>
        <h3>Tạo user mới</h3>
        <input id="username" placeholder="username">
        <input id="password" placeholder="password">
        <input id="phone" placeholder="phone">
        <button onclick="createUser()">Tạo user</button>
        <span id="createMsg"></span>
    </div>
    <div style="margin-top:16px;">
        <button onclick="fetchUsers()">Lấy danh sách user</button>
        <button onclick="clearList()">Clear</button>
    </div>
    <div class="user-list" id="userList"></div>
    <script>
        const api = "/users";
        async function createUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const phone = document.getElementById('phone').value;
            const user = { username, password, phone };
            document.getElementById('createMsg').textContent = '';
            try {
                const res = await fetch(api, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                if (!res.ok) throw new Error(await res.text());
                document.getElementById('createMsg').textContent = 'Tạo thành công!';
                document.getElementById('createMsg').className = 'success';
                fetchUsers();
            } catch (e) {
                document.getElementById('createMsg').textContent = 'Lỗi: ' + e.message;
                document.getElementById('createMsg').className = 'error';
            }
        }
        async function fetchUsers() {
            const list = document.getElementById('userList');
            list.innerHTML = 'Đang tải...';
            try {
                const res = await fetch(api);
                const users = await res.json();
                if (!Array.isArray(users)) throw new Error('API trả về không phải mảng');
                list.innerHTML = users.map(u => `
                    <div class="user-item">
                        <b>${u.username}</b> | ${u.phone || ''}
                        <button onclick="deleteUserByUsername('${u.username}')">Xóa</button>
                        <button onclick="showUpdateForm('${u._id || ''}', '${u.username}', '${u.phone || ''}')">Sửa</button>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<span class="error">Lỗi: ' + e.message + '</span>';
            }
        }
        function clearList() {
            document.getElementById('userList').innerHTML = '';
        }
        async function deleteUserByUsername(username) {
            if (!confirm('Xóa tất cả user có username chứa: ' + username + '?')) return;
            try {
                const res = await fetch(`/users/by-username/${encodeURIComponent(username)}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(await res.text());
                alert('Đã xóa user!');
                fetchUsers();
            } catch (e) {
                alert('Lỗi: ' + e.message);
            }
        }
        function showUpdateForm(id, username, phone) {
            const html = `
                <div class="user-item">
                    <input id="edit_username" value="${username}">
                    <input id="edit_phone" value="${phone}">
                    <button onclick="updateUser('${id}')">Lưu</button>
                    <button onclick="fetchUsers()">Hủy</button>
                </div>
            `;
            document.getElementById('userList').innerHTML = html;
        }
        async function updateUser(id) {
            const username = document.getElementById('edit_username').value;
            const phone = document.getElementById('edit_phone').value;
            try {
                const res = await fetch(`/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, phone })
                });
                if (!res.ok) throw new Error(await res.text());
                alert('Cập nhật thành công!');
                fetchUsers();
            } catch (e) {
                alert('Lỗi: ' + e.message);
            }
        }
        // Tải danh sách user khi mở trang
        fetchUsers();
    </script>
</body>
</html>
